<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>VulScan - Product Search</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				background-color: #f4f4f4;
				color: #333;
			}
			h1 {
				text-align: center;
				color: #333;
			}
			#search-form {
				text-align: center;
				margin-bottom: 20px;
			}
			#results {
				margin: 20px auto;
				width: 80%;
				max-width: 600px;
			}
			#vuln-results {
				margin-top: 20px;
			}
			table {
				width: 100%;
				border-collapse: collapse;
			}
			th, td {
				padding: 10px;
				text-align: left;
				border-bottom: 1px solid #ddd;
			}
			tr:hover {
				background-color: #f1f1f1;
			}
			ul {
				list-style-type: none;
				padding: 0;
			}
			li {
				padding: 10px;
				background-color: #fff;
				margin: 5px 0;
				border-radius: 5px;
				cursor: pointer;
			}
			li:hover {
				background-color: #f1f1f1;
			}
			.error {
				color: red;
			}
			.success {
				color: green;
			}
			.warning {
				color: orange;
			}
			.info {
				color: blue;
			}
			#vuln-table {
				margin-top: 20px;
				display: none; /* Initially hidden */
			}
			#vuln-table th, #vuln-table td {
				text-align: center;
			}
			#vuln-table th {
				background-color: #f2f2f2;
			}
			#vuln-table tr:nth-child(even) {
				background-color: #f9f9f9;
			}
			#vuln-table tr:hover {
				background-color: #f1f1f1;
			}
			#vuln-table td {
				padding: 8px;
			}
			#vuln-table th {
				padding: 10px;
			}
			#vuln-table tr {
				cursor: pointer;
			}
			#vuln-table tr:hover {
				background-color: #e0e0e0;
			}
			#vuln-table tr.selected {
				background-color: #d0ffd0;
			}
			#vuln-table tr.selected:hover {
				background-color: #c0ffc0;
			}
			#vuln-table tr.selected td {
				font-weight: bold;
			}
			#vuln-table tr.selected td:first-child {
				color: #f6821f;
			}
		</style>
	</head>
	<body>
		<h1>Product Search</h1>
		<div id="results"></div>
		<form id="search-form">
			<input type="text" id="search-input" placeholder="Enter product name" required />
			<button type="submit">Search</button>
		</form>
		<div id="vuln-results">
			<table id="vuln-table" border="1" cellpadding="5" cellspacing="0">
				<tr>
					<th>CVE ID</th>
					<th>Description</th>
					<th>Severity</th>
					<th>Fix</th>
				</tr>
				<!-- Vulnerability rows will be inserted here dynamically -->
			</table>
		</div>

		<script>
			const searchForm = document.getElementById('search-form');
			const searchInput = document.getElementById('search-input');
			const resultsDiv = document.getElementById('results');

			async function loadProductVulns(productID) {
				try {
					let page = 1;
					let vulnURL = `https://cors-proxy.cooks.fyi/https://www.cvedetails.com/vulnerability-list/vendor_id-0/product_id-${productID}/`
					let vulns = [];
					while (true) {
						const response = await fetch(vulnURL + `page-${page}`);
						if (!response.ok) {
							break;
						}
						const data = await response.text();
						const parser = new DOMParser();
						const doc = parser.parseFromString(data, 'text/html');
						const cveElements = doc.querySelectorAll('h3[data-tsvfield="cveId"]');
						const cveIDs = Array.from(cveElements).map(el => el.innerText.trim());
						vulns = vulns.concat(cveIDs);
						page++;
						if (cveIDs.length === 0) {
							break;
						}
					}
					return vulns;
				} catch (error) {
					resultsDiv.innerHTML = `<p>Error: ${error.message}</p>`;
				}
			}

			async function loadCVEData(row, cveID) {
				const response = await fetch(`https://cors-proxy.cooks.fyi/https://vulscan.warehouse.workers.dev/cve?cve=${cveID}`);
				const data = await response.json();
				row.innerHTML = `
					<td>${data.cve_id}</td>
					<td>${data.summary}</td>
					<td>${data.cvss}</td>
					<td>${data.propose_action}</td>
				`;
			}

			function populateVulnsTable(vulns) {
				const vulnTable = document.getElementById('vuln-table');
				vulnTable.innerHTML = `
					<tr>
						<th style="width: 15%;">CVE ID</th>
						<th style="width: 60%;">Description</th>
						<th style="width: 5%;">Severity</th>
						<th style="width: 20%;">Fix</th>
					</tr>
				`;
				vulns.forEach((cveID) => {
					const row = document.createElement('tr');
					row.innerHTML = `
						<td>${cveID}</td>
						<td>Loading...</td>
						<td>Loading...</td>
						<td>Loading...</td>
					`;
					vulnTable.appendChild(row);
					loadCVEData(row, cveID);
				});
				vulnTable.style.display = 'table';
				vulnTable.scrollIntoView({ behavior: 'smooth' });
			}

			async function displayResults(data) {
				resultsDiv.innerHTML = '';
				if (data && data.length > 0) {
					var products = data.filter(item => item.category === 'Products');
					const ul = document.createElement('ul');
					products.forEach((item) => {
						const li = document.createElement('li');
						li.textContent = `${item.label} (ID: ${item.id})`;
						ul.appendChild(li);
						li.addEventListener('click', () => {
							resultsDiv.innerHTML = `<h2>Loading vulnerabilities for ${item.label}...</h2>`;
							loadProductVulns(item.id).then(vulns => {
								if (vulns && vulns.length > 0) {
									populateVulnsTable(vulns);
									resultsDiv.innerHTML = `<h2>${vulns.length} Vulnerabilities for ${item.label}</h2>`;
								} else {
									resultsDiv.innerHTML = `<p>No vulnerabilities found for ${item.label}.</p>`;
								}
							}).catch(error => {
								resultsDiv.innerHTML = `<p>Error: ${error.message}</p>`;
							});
						});
					});
					resultsDiv.appendChild(ul);
				} else {
					resultsDiv.innerHTML = '<h2>No results found.</h2>';
				}
			}

			// https://cors-proxy.cooks.fyi/https://example.com
			if (searchForm) {
				searchForm.addEventListener('submit', async (event) => {
					event.preventDefault();
					const query = searchInput.value.trim();
					if (query) {
						try {
							const response = await fetch(`https://cors-proxy.cooks.fyi/https://www.cvedetails.com/vulnerability-search-autocomplete.php?q=${encodeURIComponent(query)}`);
							if (!response.ok) {
								throw new Error('Network response was not ok');
							}
							const data = await response.json();
							displayResults(data);
							const clearButton = document.createElement('button');
							clearButton.textContent = 'Clear Results';
							clearButton.style.marginLeft = '10px';
							clearButton.addEventListener('click', () => {
								resultsDiv.innerHTML = '';
								searchInput.value = '';
								try { document.getElementById('vuln-table').remove(); } catch (error) {}
								clearButton.remove();
								searchInput.focus();
							});
							searchForm.appendChild(clearButton);
						} catch (error) {
							resultsDiv.innerHTML = `<p>Error: ${error.message}</p>`;
						}
					}
				});
			}
		</script>
	</body>
</html>
